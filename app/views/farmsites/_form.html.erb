
<style>
#mapCanvas {
  width: 400px;
  height: 300px;
  float: left;
}
#infoPanel {
  float: left;
  margin-left: 10px;
}
#infoPanel div {
  margin-bottom: 5px;
}
</style>

<div class = "modal-dialog modal-lg" > 
  <div class = "modal-content" > 
    
    <%= simple_form_for(@farmsite) do |f| %>
    <% if @farmsite.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(farmsite.errors.count, "error") %> prohibited this farmsite from being saved:</h2>

      <% @farmsite.errors.full_messages.each do |message| %>
      <li><%= message %></li>
      <% end %>
    </div>
    
    <% end %>

    <div class = "modal-header" >
      <center><h4 class = "modal-title" >Farm Site</h4></center>
    </div>
    
    <div class = "modal-body" >
      <div class="row">
        <div class="well">
          <div class="panel panel-default">
            
            <div class="panel-body">

              <div class="row">
                <div class="col-sm-6">
                  <div class="form-inputs">
                    
                    <%= f.label "Name:" %>
                    <%= f.text_field :farmsitename, :class => "form-control", :placeholder => "Farm name" %>

                    <%= f.label "No phone:" %>
                    <%= f.text_field :farmsiteownerphoneno, :class => "form-control", :placeholder => "Phone Number" %>

                    <%= f.label "Size:" %>
                    <%= f.text_field :farmsitesize, :class => "form-control", :placeholder => "Farm size in acres" %>
                    <span class="input-group-addon" id="basic-addon2">acres</span>



                    <%= f.label "Latitude:" %>
                    <%= f.text_field :latitude, :class => "form-control",readonly: true %>

                    <%= f.label "Longitude:" %>
                    <%= f.text_field :longitude, :class => "form-control",readonly: true %>

                    <%= f.label "Edit Actual Address:" %>
                    <%= f.text_area :farmsiteaddress, :class => "form-control", :placeholder => "Farm address" %>
                  </div> </div>

                  <div class="col-sm-6">

                  <%= f.label "Where your farm located?:" %>
                    
                    
                    
                   <!--  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
                    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %> -->
                    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
                
                   <script src="//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js" type ="text/javascript"></script>
                     
                     <div id="floating-panel">
                    <input id="search_address" type="textbox" placeholder="Your Farm Area">
                    <input id="submit" type="button" value="Search">
                        </div>
                      <div id="mapCanvas"></div>
                      <div id="infoPanel">
                        <b>Marker status:</b>
                        <div id="markerStatus"><i>Click and drag the marker.</i></div>
                        <b>Current position:</b>
                        <div id="info"></div>
                        <b>Closest matching address:</b>
                        <div id="address"></div>      
                      
                      
                      <div>
                      </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
          

          <center><div class="actions">
            <%= f.submit 'Create',class: 'btn btn-lg btn-success'%>
          </div></center>

          <% end %>
        </div>
      </div>
    </div>
    <div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div>
  </div>
</div>

</div>

<%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
<%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %> 
 <script src =  "//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script>



if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    } else { 
       
    }


function showPosition(position) {

  var latLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
  var map = new google.maps.Map(document.getElementById('mapCanvas'), {
    zoom: 15,
    center: latLng,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });
   

  //mula map
  var marker = new google.maps.Marker({
    position: latLng,
    title: 'Your Location',
    map: map,
    draggable: true
  });


  var circle = new google.maps.Circle({
  map: map,
  radius: 50,    // 10 miles in metres
  fillColor: '##73E444'
});
circle.bindTo('center', marker, 'position');

  //start positon
          var geocoder = new google.maps.Geocoder();



          function geocodePosition(pos) {
            geocoder.geocode({
              latLng: pos
            }, function(responses) {
              if (responses && responses.length > 0) {
                updateMarkerAddress(responses[0].formatted_address);
              } else {
                updateMarkerAddress('Cannot determine address at this location.');
              }
            });
          }

          function updateMarkerStatus(str) {
            document.getElementById('markerStatus').innerHTML = str;
          }

          function updateMarkerPosition(latLng) {
            document.getElementById('info').innerHTML = [
            latLng.lat(),
            latLng.lng()
            ].join(', ');
          }
          

          function updateMarkerAddress(str) {
            // document.getElementById('address').innerHTML = str;
            $("#address").html(str)
            $("#farmsite_farmsiteaddress").val(str)
          }


              // Update current position info.
        updateMarkerPosition(latLng);
        geocodePosition(latLng);

        // Add dragging event listeners.
        google.maps.event.addListener(marker, 'dragstart', function() {
          updateMarkerAddress('Dragging...');
        });

        google.maps.event.addListener(marker, 'drag', function() {
          updateMarkerStatus('Dragging...');
          updateMarkerPosition(marker.getPosition());
        });

        google.maps.event.addListener(marker, 'dragend', function() {
          updateMarkerStatus('Drag ended');
          console.log("dadda")
          console.log(marker.getPosition())
          console.log(marker.getPosition().lat())
          geocodePosition(marker.getPosition());
          $("#farmsite_latitude").val(marker.getPosition().lat())
          $("#farmsite_longitude").val(marker.getPosition().lng())
          // $("#farmsite_farmsiteaddress").val(marker.getPosition().lng())
        });
          // Onload handler to fire off the app.
        //google.maps.event.addDomListener(window, 'load', initialize);

        function geocodeAddress(geocoder, resultsMap) {
          var address = document.getElementById('search_address').value;
          geocoder.geocode({'address': address}, function(results, status) {
            if (status === 'OK') {
              resultsMap.setCenter(results[0].geometry.location);
              // var marker = new google.maps.Marker({
              //   map: resultsMap,
              //   position: results[0].geometry.location
              // });
              marker.setPosition( results[0].geometry.location )
              console.log(results[0].geometry.location)
              updateMarkerPosition(results[0].geometry.location)
            } else {
              alert('Geocode was not successful for the following reason: ' + status);
            }
          });
        }
        //end positon

        //search
        document.getElementById('submit').addEventListener('click', function() {
          geocodeAddress(geocoder, map);
        });  
  }
</script>

